#!/bin/bash
# del-vless.sh
# Usage: ./del-vless.sh <username>

USER=$1
CONFIG="/etc/xray/config.json"
DB="/etc/vless/.vless.db"

if [[ -z "$USER" ]]; then
    echo "Usage: $0 <username>"
    exit 1
fi

# cek apakah user ada
if ! grep -qw "$USER" "$CONFIG"; then
    echo "❌ User $USER tidak ditemukan di $CONFIG"
    exit 1
fi

# ambil tanggal exp (kolom ke-3 setelah ###)
EXP=$(grep -w "^#vl $USER" "$CONFIG" | awk '{print $3}')

# hapus di config.json
sed -i "/^#vl $USER $EXP/,/^},{/d" $CONFIG
sed -i "/^#vlg $USER $EXP/,/^},{/d" $CONFIG

# hapus di db
if [[ -f "$DB" ]]; then
    sed -i "/^### $USER $EXP/,/^},{/d" $DB
fi

# hapus file user
rm -rf /etc/vless/$USER
rm -rf /etc/julak/limit/vless/ip/$USER
rm -rf /home/vps/public_html/vless-$USER.txt

# restart xray
systemctl restart xray > /dev/null 2>&1

# hasil
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ Vless Account Deleted Successfully"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo " Client Name : $USER"
echo " Expired On  : $EXP"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
