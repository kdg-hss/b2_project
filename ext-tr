#!/bin/bash

# ========================================================
# TROJAN Account Renewal Script for Telegram Bot
# Adapted from user's renew-trojan function
# ========================================================

# Configuration
DB_FILE="/etc/trojan/.trojan.db"
CONFIG_FILE="/etc/xray/config.json"
LOG_FILE="/var/log/trojan_renew.log"
DOMAIN=$(cat /etc/xray/domain)
IP=$(curl -sS ipv4.icanhazip.com)

USERNAME="$1"
DAYS="$2"

# --- Validation Functions ---
validate_username() {
    if ! grep -q -E "^#trg $USERNAME |^#tr $USERNAME " "$CONFIG_FILE"; then
        echo "❌ Error: User $USERNAME not found in VMESS configuration."
        exit 1
    fi
}

validate_days() {
    if ! [[ "$DAYS" =~ ^[0-9]+$ && "$DAYS" -gt 0 ]]; then
        echo "❌ Error: Days to add must be a positive integer."
        exit 1
    fi
}

# --- Renewal Function ---
renew_trojan() {
    current_exp_line=$(grep -E "^#trg $USERNAME |^#tr $USERNAME " "$CONFIG_FILE" | head -n 1)
    
    if [ -z "$current_exp_line" ]; then
        echo "❌ Error: Could not find user $USERNAME's entry to determine current expiry."
        exit 1
    fi

    current_exp_date_raw=$(echo "$current_exp_line" | awk '{print $3}')
    
    # Validasi tanggal kadaluwarsa yang diambil
    if ! date -d "$current_exp_date_raw" &>/dev/null; then
        echo "❌ Error: Invalid current expiry date format for $USERNAME: $current_exp_date_raw"
        echo "Please check the user's entry in $CONFIG_FILE."
        exit 1
    fi

    # --- Logika Perhitungan Tanggal dari script renew-trojan Anda ---
    now=$(date +%Y-%m-%d)
    d1=$(date -d "$current_exp_date_raw" +%s)
    d2=$(date -d "$now" +%s)                 
    
    # Hitung sisa hari dari tanggal expired saat ini
    exp2=$(( (d1 - d2) / 86400 ))
    
    # Jika tanggal sudah lewat atau hari ini (sisa hari <= 0), mulai hitungan dari hari ini
    if [ "$exp2" -lt 0 ]; then
        exp2=0
    fi
    
    # Tambahkan hari baru ke sisa hari yang ada
    exp3=$(($exp2 + $DAYS))
    
    # Hitung tanggal expired yang baru (YYYY-MM-DD)
    new_exp_system=$(date -d "$exp3 days" +"%Y-%m-%d")
    new_exp_display=$(date -d "$new_exp_system" +"%d %b, %Y") 

    # --- Update entri di config.json dengan perintah sed yang akurat ---
    sed -i "s|#trg $USERNAME $current_exp_date_raw|#trg $USERNAME $new_exp_system|g" "$CONFIG_FILE"
    sed -i "s|#tr $USERNAME $current_exp_date_raw|#tr $USERNAME $new_exp_system|g" "$CONFIG_FILE"
    sed -i "s|### $USERNAME $current_exp_date_raw|### $USERNAME $new_exp_system|g" "$DB_FILE"

    # Log the action
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Renewed TROJAN $USERNAME for $DAYS days (new expiry: $new_exp_system) by Admin ID: $ADMIN_ID" >> "$LOG_FILE"
}

# --- Main Execution ---
validate_username
validate_days

if renew_trojan; then
    # Prepare output message for Telegram
    echo "✅ <b>TROJAN ACCOUNT RENEWED</b>"
    echo "============================="
    echo "<b>Username:</b> <code>$USERNAME</code>"
    echo "<b>Days Added:</b> $DAYS"
    echo "<b>New Expiry:</b> $new_exp_display"
    echo "============================="
    echo "<b>Server Info:</b>"
    echo "<b>IP:</b> $IP"
    echo "<b>Domain:</b> $DOMAIN"
    echo "============================="
    echo "<i>Renewed at: $(date '+%d %b, %Y %H:%M:%S')</i>"
else
    echo "❌ <b>RENEWAL FAILED</b>"
    echo "============================="
    echo "<b>Username:</b> <code>$USERNAME</code>"
    echo "<b>Error:</b> An unknown error occurred during renewal."
    exit 1
fi

: '
USER_SHORT=$(echo "$USERNAME" | cut -c 1-3) # Ambil 3 karakter pertama username
TIME2=$(date +'%Y-%m-%d %H:%M:%S')
TEXT2="
<code>◇━━━━━━━━━━━━━━◇</code>
<b>    RENEWED TROJAN SUCCES </b>
<code>◇━━━━━━━━━━━━━━◇</code>
<b>DOMAIN    :</b> <code>${DOMAIN} </code>
<b>DATE      :</b> <code>${TIME2} WIB </code>
<b>DETAIL    :</b> <code>Trx VMESS </code>
<b>USER      :</b> <code>${USER_SHORT}xxx </code>
<b>DURASI    :</b> <code>$DAYS Hari </code>
<code>◇━━━━━━━━━━━━━━◇</code>
<i> Renew Account From Server..</i>
"
# Pastikan $CHATID2 dan $URL2 didefinisikan di lingkungan atau file config terpisah
# curl -s --max-time $TIMES -d "chat_id=$CHATID2&disable_web_page_preview=1&text=$TEXT2&parse_mode=html" $URL2 >/dev/null
'

exit 0

